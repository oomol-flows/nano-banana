# Nano Banana

基于 Nano Banana 模型的 AI 图像编辑 OOMOL 工作流包。

## 概述

Nano Banana 是一个强大的图像编辑解决方案,利用 AI 技术根据自然语言指令转换图像。该包通过 OOMOL 工作流提供与 Nano Banana AI 服务的无缝集成,使高级图像编辑变得易于访问和使用。

## 功能特性

- **自然语言图像编辑**:用简单的语言描述您想要的更改,AI 将自动应用到图像上
- **多种输入方式**:支持基于 URL 的图像和本地图像文件
- **参考图像支持**:可选择提供参考图像作为风格指导
- **LLM 增强提示词**:自动优化您的编辑指令以获得最佳效果
- **批量处理**:在单个工作流中编辑多张图像
- **自动结果轮询**:处理异步操作并自动获取结果
- **本地文件处理**:上传本地图像到云端,并可选择下载编辑后的结果

## 功能模块

### 1. 任务块 (Task Blocks)

#### Nano Banana Edit
向 Nano Banana AI 服务提交图像编辑请求。

- **输入**:
  - `image_urls`: 要处理的公开可访问图像 URL 数组
  - `prompt`: 描述所需修改的自然语言指令
- **输出**:
  - `result`: 包含 request_id 和状态信息的 API 响应

#### Extract Request ID
从 API 响应中提取请求标识符以进行跟踪。

- **输入**:
  - `response`: 来自 nano-banana-edit 的 API 响应对象
- **输出**:
  - `request_id`: 用于轮询结果的唯一请求标识符

#### Nano Banana Get Result
使用请求 ID 轮询服务并获取编辑后的图像。

- **输入**:
  - `request_id`: 来自 nano-banana-edit 的请求 ID
  - `poll_interval` (可选): 轮询尝试之间的秒数
  - `max_attempts` (可选): 超时前的最大轮询尝试次数
- **输出**:
  - `images`: 成功编辑的图像 URL 数组

### 2. 子流程 (Subflows)

#### URL Images Nano Banana Edit
使用 LLM 增强提示词编辑 URL 图像的完整工作流。

- **输入**:
  - `main_picture`: 要编辑的主图像 URL
  - `reference_picture` (可选): 用于风格指导的参考图像 URL
  - `prompt`: 自然语言编辑指令
  - `poll_interval` (可选): 轮询间隔配置
  - `max_attempts` (可选): 最大轮询尝试次数
- **输出**:
  - `images`: 编辑后的图像 URL 数组

此子流程自动执行以下操作:
1. 使用 LLM 增强您的提示词以创建精确的编辑指令
2. 向 Nano Banana 提交编辑请求
3. 轮询结果直到完成
4. 返回编辑后的图像 URL

#### Local Image Nano Banana Edit
编辑本地图像文件的完整工作流。

- **输入**:
  - `main_picture`: 主图像文件的本地路径
  - `reference_picture` (可选): 参考图像文件的本地路径
  - `prompt`: 自然语言编辑指令
  - `save_dir` (可选): 本地保存编辑后图像的目录
  - `poll_interval` (可选): 轮询间隔配置
  - `max_attempts` (可选): 最大轮询尝试次数
- **输出**:
  - `images`: 编辑后的图像 URL 或本地路径数组

此子流程自动执行以下操作:
1. 上传本地图像到云端
2. 使用基于 URL 的编辑工作流
3. 可选择将编辑后的图像下载到指定目录
4. 返回 URL 或本地文件路径

## 快速开始

### 前置要求

- 已安装 OOMOL Studio
- Python 3.10+ 环境
- 互联网连接以访问 API

### 安装

1. 在 OOMOL Studio 中安装该包
2. 依赖项将通过引导脚本自动安装

### 基本使用

#### 示例 1: 编辑 URL 图像

1. 使用 "URL Images Nano Banana Edit" 子流程
2. 提供主图像 URL
3. 可选添加参考图像 URL
4. 输入您的编辑指令(例如:"将天空改为日落颜色")
5. 运行工作流
6. 接收编辑后的图像 URL

#### 示例 2: 编辑本地图像

1. 使用 "Local Image Nano Banana Edit" 子流程
2. 选择您的主图像文件
3. 可选选择参考图像
4. 输入您的编辑指令
5. 可选指定保存目录
6. 运行工作流
7. 接收编辑后的图像(如果指定了目录则保存到本地)

## 工作原理

Nano Banana 包分几个阶段运行:

1. **输入处理**: 接受 URL 或本地文件形式的图像。本地文件会自动上传到云存储。

2. **提示词增强**: 您的自然语言指令会由 LLM 处理,创建精确、优化的编辑提示词,使 AI 模型能够更好地理解。

3. **API 提交**: 图像和增强后的提示词通过 OOMOL Fusion API 发送到 Nano Banana AI 服务。

4. **异步处理**: 服务异步处理您的请求,返回用于跟踪的请求 ID。

5. **结果轮询**: 工作流自动定期轮询服务以检查处理是否完成。

6. **结果获取**: 处理完成后,检索编辑后的图像并以 URL 形式返回或保存到本地。

## 技术细节

### 架构

该包使用 OOMOL 的工作流架构构建,包含三个核心任务块和两个高级子流程,将这些任务组合成完整的编辑管道。

### API 集成

- **服务**: OOMOL Fusion API
- **端点**: `https://fusion-api.oomol.com/v1/fal-nano-banana-edit/submit`
- **认证**: 通过 OOMOL 上下文自动管理令牌
- **错误处理**: 针对 SSL 和连接错误的指数退避自动重试

### 依赖项

- `requests`: 用于 API 通信的 HTTP 客户端
- `downloaderx`: 文件下载工具
- `upload-to-cloud` 包: 云存储集成
- `array` 包: 数组处理工具
- `llm` 包: 提示词增强的 LLM 集成

## 配置

### 轮询选项

两个子流程都支持可选的轮询配置:

- **poll_interval**: 结果检查之间的时间(秒)(默认值:服务定义)
- **max_attempts**: 超时前的最大轮询尝试次数(默认值:服务定义)

根据图像复杂度和处理时间要求调整这些值。

## 故障排除

### 常见问题

**API 连接错误**
- 该包包含指数退避的自动重试逻辑
- SSL 错误会自动处理,最多重试 3 次

**轮询期间超时**
- 对于复杂的编辑任务,增加 `max_attempts`
- 增加 `poll_interval` 以减少服务器负载

**文件上传失败**
- 确保本地文件可访问且未损坏
- 检查文件路径是否正确

## 许可证

详见项目许可证文件。

## 支持

如有问题,请参阅 OOMOL 文档或通过 OOMOL 平台联系支持。
